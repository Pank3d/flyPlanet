name: Deploy VLESS Reality Stack

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
  VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
  REALITY_DEST: ${{ secrets.REALITY_DEST || 'yandex.ru' }}
  REALITY_SNI: ${{ secrets.REALITY_SNI || 'yandex.ru ya.ru' }}
  BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

jobs:
  deploy-xray:
    name: Deploy Xray Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install paramiko

      - name: Deploy Xray to VPS
        id: deploy_xray
        run: |
          cd server
          python deploy.py \
            --host ${{ env.VPS_HOST }} \
            --port ${{ env.VPS_PORT }} \
            --user ${{ env.VPS_USER }} \
            --password "${{ env.VPS_PASSWORD }}" \
            --dest ${{ env.REALITY_DEST }} \
            --sni ${{ env.REALITY_SNI }} \
            --alias "Reality-Server"

      - name: Extract server info
        id: extract
        run: |
          if [ -f reality_server_info.json ]; then
            PUBLIC_KEY=$(jq -r '.public_key' reality_server_info.json)
            SERVER_IP=$(jq -r '.server' reality_server_info.json)
            echo "public_key=$PUBLIC_KEY" >> $GITHUB_OUTPUT
            echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT

            # Save for next job
            echo "PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
            echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
          fi

      - name: Upload server info
        uses: actions/upload-artifact@v4
        with:
          name: server-info
          path: reality_server_info.json
          retention-days: 30

  deploy-bot:
    name: Deploy Telegram Bot
    runs-on: ubuntu-latest
    needs: deploy-xray

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download server info
        uses: actions/download-artifact@v4
        with:
          name: server-info
        continue-on-error: true

      - name: Extract credentials
        id: extract
        run: |
          if [ -f reality_server_info.json ]; then
            PUBLIC_KEY=$(jq -r '.public_key' reality_server_info.json)
            SERVER_IP=$(jq -r '.server' reality_server_info.json)
          else
            PUBLIC_KEY="${{ secrets.XRAY_PUBLIC_KEY }}"
            SERVER_IP="${{ env.VPS_HOST }}"
          fi

          echo "public_key=$PUBLIC_KEY" >> $GITHUB_OUTPUT
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ env.VPS_PASSWORD }}
          port: ${{ env.VPS_PORT }}
          script: |
            set -e

            # Install Docker if not installed
            if ! command -v docker &> /dev/null; then
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              systemctl enable docker
              systemctl start docker
            fi

            # Install Docker Compose if not installed
            if ! command -v docker-compose &> /dev/null; then
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi

            # Create project directory
            mkdir -p ~/vless-reality-project
            cd ~/vless-reality-project

      - name: Copy project files
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ env.VPS_PASSWORD }}
          port: ${{ env.VPS_PORT }}
          source: "bot/*,docker-compose.yml"
          target: "~/vless-reality-project"

      - name: Deploy with Docker
        uses: appleboy/ssh-action@v1.0.0
        env:
          BOT_TOKEN: ${{ env.BOT_TOKEN }}
          SERVER_IP: ${{ steps.extract.outputs.server_ip }}
          PUBLIC_KEY: ${{ steps.extract.outputs.public_key }}
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          password: ${{ env.VPS_PASSWORD }}
          port: ${{ env.VPS_PORT }}
          envs: BOT_TOKEN,SERVER_IP,PUBLIC_KEY
          script: |
            cd ~/vless-reality-project

            # Create .env file
            cat > .env << EOF
            BOT_TOKEN=${BOT_TOKEN}
            SERVER_IP=${SERVER_IP}
            PUBLIC_KEY=${PUBLIC_KEY}
            EOF

            # Stop old container
            docker-compose down 2>/dev/null || true

            # Start with Docker Compose
            docker-compose up -d --build

            # Show status
            echo "Bot deployment completed!"
            docker-compose ps
            docker-compose logs --tail=20 bot

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-xray, deploy-bot]
    if: always()

    steps:
      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        continue-on-error: true
        with:
          to: ${{ secrets.NOTIFICATION_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            Deployment completed

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            Xray: ${{ needs.deploy-xray.result }}
            Bot: ${{ needs.deploy-bot.result }}

            Server: ${{ secrets.VPS_HOST }}
